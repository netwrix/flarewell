<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" class="_Skins_Netwrix_Website" lang="en-us" xml:lang="en-us" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../../../../" data-mc-has-content-body="True" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="[%=System.LinkedTitle%]|Scripts &amp; Triggers Manager|[%=System.LinkedTitle%]|Tip and Tricks">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="../../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Print.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/foundation.6.2.3.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/Styles.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/Tablet.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/Mobile.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/Print.css" rel="stylesheet" type="text/css" data-mc-generated="True" /><title>How to use Scripts Manager Event Log Triggers to Map Network Drives when a VPN is Connected</title>
        <link href="../../../Resources/Stylesheets/StealthbitsTemplate.css" rel="stylesheet" type="text/css" />
        <script src="../../../../Resources/Scripts/jquery.min.js" type="text/javascript">
        </script>
        <script src="../../../../Resources/Scripts/purify.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/require.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/require.config.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/foundation.6.2.3_custom.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/plugins.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapAll.js" type="text/javascript" defer="defer">
        </script>
    </head>
    <body>
        <div class="foundation-wrap off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper="">
                <aside class="off-canvas position-right" role="navigation" id="offCanvas" data-off-canvas="" data-position="right" data-mc-ignore="true">
                    <ul class="off-canvas-drilldown vertical menu off-canvas-list" data-drilldown="" data-mc-back-link="Back" data-mc-css-tree-node-expanded="is-drilldown-submenu-parent" data-mc-css-tree-node-collapsed="is-drilldown-submenu-parent" data-mc-css-sub-menu="vertical menu slide-in-right is-drilldown-submenu" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="True" data-mc-include-back="True" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.drilldown" data-mc-toc="True">
                    </ul>
                </aside>
                <div class="off-canvas-content inner-wrap" data-off-canvas-content="">
                    <div data-sticky-container="" class="title-bar-container">
                        <nav class="title-bar tab-bar sticky" aria-label="title tab bar" data-sticky="" data-options="marginTop:0" style="width:100%" data-sticky-on="only screen and (max-width: 1279px)" data-mc-ignore="true"><a class="skip-to-content fluid-skip showOnFocus" href="#">Skip To Main Content</a>
                            <div class="middle title-bar-section outer-row clearfix">
                                <div class="menu-icon-container relative clearfix">
                                    <div class="central-account-wrapper">
                                        <div class="central-dropdown"><a class="central-account-drop"><span class="central-account-image"></span><span class="central-account-text">Account</span></a>
                                            <div class="central-dropdown-content"><a class="MCCentralLink central-dropdown-content-settings">Settings</a>
                                                <hr class="central-separator" /><a class="MCCentralLink central-dropdown-content-logout">Logout</a>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="menu-icon" aria-label="Show Navigation Panel" data-toggle="offCanvas"><span></span>
                                    </button>
                                </div>
                            </div>
                            <div class="title-bar-layout outer-row">
                                <div class="logo-wrapper"><a class="logo" href="../../Overview.htm" alt="Logo"></a>
                                </div>
                                <div class="navigation-wrapper nocontent">
                                    <ul class="navigation clearfix" role="navigation" data-mc-css-tree-node-has-children="has-children" data-mc-css-sub-menu="sub-menu" data-mc-expand-event="mouseenter" data-mc-top-nav-menu="True" data-mc-max-depth="3" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                        <li class="placeholder" style="visibility:hidden"><a>placeholder</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="central-account-wrapper">
                                    <div class="central-dropdown"><a class="central-account-drop"><span class="central-account-image"></span><span class="central-account-text">Account</span></a>
                                        <div class="central-dropdown-content"><a class="MCCentralLink central-dropdown-content-settings">Settings</a>
                                            <hr class="central-separator" /><a class="MCCentralLink central-dropdown-content-logout">Logout</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="nav-search-wrapper">
                                    <div class="nav-search row">
                                        <form class="search" action="#">
                                            <div class="search-bar search-bar-container needs-pie">
                                                <input class="search-field needs-pie" type="search" aria-label="Search Field" placeholder="Search" />
                                                <div class="search-filter-wrapper"><span class="invisible-label" id="search-filters-label">Filter: </span>
                                                    <div class="search-filter" aria-haspopup="true" aria-controls="sf-content" aria-expanded="false" aria-label="Search Filter" title="All Files" role="button" tabindex="0">
                                                    </div>
                                                    <div class="search-filter-content" id="sf-content">
                                                        <ul>
                                                            <li>
                                                                <button class="mc-dropdown-item" aria-labelledby="search-filters-label filterSelectorLabel-00001"><span id="filterSelectorLabel-00001">All Files</span>
                                                                </button>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="search-submit-wrapper" dir="ltr">
                                                    <div class="search-submit" title="Search" role="button" tabindex="0"><span class="invisible-label">Submit Search</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="main-section">
                        <div class="row outer-row sidenav-layout">
                            <nav class="sidenav-wrapper">
                                <div class="sidenav-container">
                                    <ul class="off-canvas-accordion vertical menu sidenav" data-accordion-menu="" data-mc-css-tree-node-expanded="is-accordion-submenu-parent" data-mc-css-tree-node-collapsed="is-accordion-submenu-parent" data-mc-css-sub-menu="vertical menu accordion-menu is-accordion-submenu nested" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="False" data-mc-include-back="False" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.accordionMenu" data-mc-toc="True" data-mc-side-nav-menu="True">
                                    </ul>
                                </div>
                            </nav>
                            <div class="body-container">
                                <div id="mc-main-content" role="main" data-mc-content-body="True">
                                    <h1>How to use Scripts Manager Event Log Triggers to Map Network Drives when a VPN is Connected</h1>
                                    <p class="Recommended-1" data-mc-autonum="&lt;span style=&quot;color: #fb8000;&quot; class=&quot;mcFormatColor&quot;&gt;&lt;b&gt;&lt;i&gt;RECOMMENDED: &lt;/i&gt;&lt;/b&gt;&lt;/span&gt;"><span class="autonumber"><span class="Recommended"><span style="color: #fb8000;" class="mcFormatColor"><b><i>RECOMMENDED: </i></b></span></span></span> <span class="mc-variable PolicyPak.Product_Long_Name variable">Netwrix Endpoint Policy Manager (formerly PolicyPak)</span> version 2791 or higher must be used.</p>
                                    <p class="Step-Reset" data-mc-autonum="&lt;b&gt;Step 1 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 1 – </b></span></span>Create a new Scripts &amp; Triggers policy on the computer side, choose switched mode like in the screenshot below.</p>
                                    <p>
                                        <img alt="" height="482" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_1_image-20210801230156-1.png" width="691" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 2 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 2 – </b></span></span>At the "On apply action" screen select "PowerShell script" from the dropdown, then in the main text window, paste in the script below, check the option "Run script as user, then click "Next".</p>
                                    <div class="codeSnippet">
                                        <div style="mc-code-lang: PlainText;" class="codeSnippetBody" data-mc-continue="False" data-mc-line-number-start="1" data-mc-use-line-numbers="False"><pre><code># Set Launch Folder Windows in a Separate Process to Enabled<br />if((Test-Path -LiteralPath "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced") -ne $true) {<br />&#160;&#160;&#160;&#160;New-Item "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -force -ea SilentlyContinue<br />};<br /><br />New-ItemProperty -LiteralPath 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'SeparateProcess' -Value 1 -PropertyType DWord -Force -ea SilentlyContinue;</code></pre>
                                        </div>
                                    </div>
                                    <p>
                                        <img alt="" height="503" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_2_image-20210801230156-2.png" width="805" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 3 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 3 – </b></span></span>Then click "Next" at the "On revert action" screen to skip that screen, then at the "Specify process mode" screen choose the "Once" option.</p>
                                    <p>
                                        <img alt="" height="503" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_3_image-20210801230156-3.png" width="749" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 4 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 4 – </b></span></span>At the "Policy settings" screen give the policy a descriptive name then click "Finish".</p>
                                    <p>
                                        <img alt="" height="508" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_4_image-20210801230156-4.png" width="798" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 5 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 5 – </b></span></span>Now create another policy (Map drives when VPN Connect Event ID is Detected) using Scripts &amp; Triggers on the computer side, choose switched-mode like in the screenshot below.</p>
                                    <p>
                                        <img src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_5_image-20210801230156-5.png" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 6 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 6 – </b></span></span>At the "On apply action" screen select "PowerShell script" from the dropdown, then in the main text window, paste in the script below then change the drive mappings to match the settings needed for your environment, check the option "Run script as user, then click "Next".</p>
                                    <div class="codeSnippet">
                                        <div style="mc-code-lang: PlainText;" class="codeSnippetBody" data-mc-continue="False" data-mc-line-number-start="1" data-mc-use-line-numbers="False"><pre><code># Wait for DNS to settle after VPN connects<br />Start-Sleep -s 10<br /><br /># Map G Drive<br />if (-not(get-psdrive -name "G" -ErrorAction SilentlyContinue)) {<br />&#160;&#160;&#160;&#160;New-PSDrive -name "G" -PSProvider FileSystem -Root \\Server\share1 -Persist<br />}<br /><br /># Map H Drive<br />if (-not(get-psdrive -name "H" -ErrorAction SilentlyContinue)) {<br />&#160;&#160;&#160;&#160;New-PSDrive -name "H" -PSProvider FileSystem -Root \\Server\Share2 -Persist<br />}</code></pre>
                                        </div>
                                    </div>
                                    <p>
                                        <img alt="" height="544" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_6_image-20210801230156-6.png" width="739" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 7 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 7 – </b></span></span>Click "Next" at the "On revert action" screen to skip that screen, then at the "Specify process mode" screen choose the "On trigger" option, then choose "Event log" from the drop down before clicking "Next" to continue.</p>
                                    <p>
                                        <img alt="" height="527" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_7_image-20210801230156-7.png" width="780" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 8 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 8 – </b></span></span>Before continuing Connect to the VPN then open the Windows application log and locate the <a name="_Hlk77945852"></a>successful VPN Connection event, take note of the Level, the source, and the Event ID number for that event as you will need them in the next step.</p>
                                    <p>For this example I used an Azure Point-to-Site VPN connection, and the successful connection Event ID number is 20225</p>
                                    <p>
                                        <img alt="" height="449" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_8_image-20210801230156-8.png" width="694" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 9 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 9 – </b></span></span>Now continue onward from Step 7 above using the information you gathered in Step 8, ensure your Trigger settings look similar to mine below, before clicking "Next".</p>
                                    <p>
                                        <img alt="" height="511" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_9_image-20210801230156-9.png" width="789" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 10 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 10 – </b></span></span>At the next Trigger settings screen click "Next" without editing the query.</p>
                                    <p>
                                        <img alt="" height="509" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_10_image-20210801230156-10.png" width="726" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 11 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 11 – </b></span></span>
          At the Policy Settings screen provide a descriptive name for the policy and then click "Finish".</p>
                                    <p>
                                        <img alt="" height="510" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_11_image-20210801230156-11.png" width="732" />
                                    </p>
                                    <p class="Note-1" data-mc-autonum="&lt;b&gt;NOTE: &lt;/b&gt;"><span class="autonumber"><span class="Note"><b>NOTE: </b></span></span> You should have two policies now:
</p>
                                    <p>
                                        <img alt="" height="62" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_12_image-20210801230156-12.png" width="393" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 12 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 12 – </b></span></span>Lastly, test the policy by logging into a computer, (or run gpupdate if already logged in) and then connect to a VPN as a user who should receive the policy. If everything 	
 
      
          works you should see the network drives show up in File Explorer</p>
                                    <p>
                                        <img alt="" height="81" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_13_image-20210801230156-13.png" width="517" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 13 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 13 – </b></span></span>     
     
           Optionally, create a new Scripts and Triggers policy that disconnects the drives when the VPN disconnects by using the script below and also changing the trigger to "Event log", and configuring the correct settings for the successful VPN disconnect event. Please see below for a VPN disconnect example using Azure Point-to-Site VPN.</p>
                                    <p>
                                        <img alt="" height="507" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_14_image-20210801230156-14.png" width="727" />
                                    </p>
                                    <p>
                                        <img alt="" height="527" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_15_image-20210801230156-15.png" width="780" />
                                    </p>
                                    <p>VPN disconnect example using Azure Point-to-Site VPN</p>
                                    <p>
                                        <img alt="" height="387" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_16_image-20210801230156-16.png" width="597" />
                                    </p>
                                    <p>
                                        <img alt="" height="505" src="../../../Resources/Images/ScriptsTriggers/MappedDrives/848_17_image-20210801230156-17.png" width="727" />
                                    </p>
                                    <p class="Note-1" data-mc-autonum="&lt;b&gt;NOTE: &lt;/b&gt;"><span class="autonumber"><span class="Note"><b>NOTE: </b></span></span>"On trigger" does not work with Revert action script which is why you need to create a new policy to disconnect the drives.</p><![CDATA[       ]]></div>
                            </div>
                        </div>
                    </div><a data-close="true"></a>
                </div>
            </div>
        </div>
    </body>
</html>