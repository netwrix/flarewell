<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" class="_Skins_Netwrix_Website" lang="en-us" xml:lang="en-us" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../../../../" data-mc-has-content-body="True" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="[%=System.LinkedTitle%]|Least Privilege Manager|[%=System.LinkedTitle%]|Troubleshooting">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="../../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Print.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/foundation.6.2.3.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/Styles.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/Tablet.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/Mobile.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Fluid/Stylesheets/Print.css" rel="stylesheet" type="text/css" data-mc-generated="True" /><title>How-to troubleshoot LPM rules for Kaseya Agent Service?</title>
        <link href="../../../Resources/Stylesheets/StealthbitsTemplate.css" rel="stylesheet" type="text/css" />
        <script src="../../../../Resources/Scripts/jquery.min.js" type="text/javascript">
        </script>
        <script src="../../../../Resources/Scripts/purify.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/require.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/require.config.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/foundation.6.2.3_custom.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/plugins.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapAll.js" type="text/javascript" defer="defer">
        </script>
    </head>
    <body>
        <div class="foundation-wrap off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper="">
                <aside class="off-canvas position-right" role="navigation" id="offCanvas" data-off-canvas="" data-position="right" data-mc-ignore="true">
                    <ul class="off-canvas-drilldown vertical menu off-canvas-list" data-drilldown="" data-mc-back-link="Back" data-mc-css-tree-node-expanded="is-drilldown-submenu-parent" data-mc-css-tree-node-collapsed="is-drilldown-submenu-parent" data-mc-css-sub-menu="vertical menu slide-in-right is-drilldown-submenu" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="True" data-mc-include-back="True" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.drilldown" data-mc-toc="True">
                    </ul>
                </aside>
                <div class="off-canvas-content inner-wrap" data-off-canvas-content="">
                    <div data-sticky-container="" class="title-bar-container">
                        <nav class="title-bar tab-bar sticky" aria-label="title tab bar" data-sticky="" data-options="marginTop:0" style="width:100%" data-sticky-on="only screen and (max-width: 1279px)" data-mc-ignore="true"><a class="skip-to-content fluid-skip showOnFocus" href="#">Skip To Main Content</a>
                            <div class="middle title-bar-section outer-row clearfix">
                                <div class="menu-icon-container relative clearfix">
                                    <div class="central-account-wrapper">
                                        <div class="central-dropdown"><a class="central-account-drop"><span class="central-account-image"></span><span class="central-account-text">Account</span></a>
                                            <div class="central-dropdown-content"><a class="MCCentralLink central-dropdown-content-settings">Settings</a>
                                                <hr class="central-separator" /><a class="MCCentralLink central-dropdown-content-logout">Logout</a>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="menu-icon" aria-label="Show Navigation Panel" data-toggle="offCanvas"><span></span>
                                    </button>
                                </div>
                            </div>
                            <div class="title-bar-layout outer-row">
                                <div class="logo-wrapper"><a class="logo" href="../../Overview.htm" alt="Logo"></a>
                                </div>
                                <div class="navigation-wrapper nocontent">
                                    <ul class="navigation clearfix" role="navigation" data-mc-css-tree-node-has-children="has-children" data-mc-css-sub-menu="sub-menu" data-mc-expand-event="mouseenter" data-mc-top-nav-menu="True" data-mc-max-depth="3" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                        <li class="placeholder" style="visibility:hidden"><a>placeholder</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="central-account-wrapper">
                                    <div class="central-dropdown"><a class="central-account-drop"><span class="central-account-image"></span><span class="central-account-text">Account</span></a>
                                        <div class="central-dropdown-content"><a class="MCCentralLink central-dropdown-content-settings">Settings</a>
                                            <hr class="central-separator" /><a class="MCCentralLink central-dropdown-content-logout">Logout</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="nav-search-wrapper">
                                    <div class="nav-search row">
                                        <form class="search" action="#">
                                            <div class="search-bar search-bar-container needs-pie">
                                                <input class="search-field needs-pie" type="search" aria-label="Search Field" placeholder="Search" />
                                                <div class="search-filter-wrapper"><span class="invisible-label" id="search-filters-label">Filter: </span>
                                                    <div class="search-filter" aria-haspopup="true" aria-controls="sf-content" aria-expanded="false" aria-label="Search Filter" title="All Files" role="button" tabindex="0">
                                                    </div>
                                                    <div class="search-filter-content" id="sf-content">
                                                        <ul>
                                                            <li>
                                                                <button class="mc-dropdown-item" aria-labelledby="search-filters-label filterSelectorLabel-00001"><span id="filterSelectorLabel-00001">All Files</span>
                                                                </button>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="search-submit-wrapper" dir="ltr">
                                                    <div class="search-submit" title="Search" role="button" tabindex="0"><span class="invisible-label">Submit Search</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="main-section">
                        <div class="row outer-row sidenav-layout">
                            <nav class="sidenav-wrapper">
                                <div class="sidenav-container">
                                    <ul class="off-canvas-accordion vertical menu sidenav" data-accordion-menu="" data-mc-css-tree-node-expanded="is-accordion-submenu-parent" data-mc-css-tree-node-collapsed="is-accordion-submenu-parent" data-mc-css-sub-menu="vertical menu accordion-menu is-accordion-submenu nested" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="False" data-mc-include-back="False" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.accordionMenu" data-mc-toc="True" data-mc-side-nav-menu="True">
                                    </ul>
                                </div>
                            </nav>
                            <div class="body-container">
                                <div id="mc-main-content" role="main" data-mc-content-body="True">
                                    <h1>How-to troubleshoot LPM rules for Kaseya Agent Service?</h1>
                                    <p>It seems that the Kaseya Agent service starts before the <span class="mc-variable PolicyPak.Product_Long_Name variable">Netwrix Endpoint Policy Manager (formerly PolicyPak)</span> services, which means <span class="mc-variable PolicyPak.Product_Short_Name variable">Endpoint Policy Manager</span> never witnesses Kaseya Agent Service (AgentMon.exe) spawning, so LPM never evaluates if it matches any defined policy.</p>
                                    <p>The owner of the "AgentMon.exe" is on the SecureRun list, the service can start, but then there it isn't matching the policy which would allow it to spawn child processes that are allowed.</p>
                                    <p>We are going to make the Kaseya service depend on the <span class="mc-variable PolicyPak.Product_Short_Name variable">Endpoint Policy Manager</span> services.</p>
                                    <p>Since we only need to do this if <span class="mc-variable PolicyPak.Product_Short_Name variable">Endpoint Policy Manager</span> exists, we'll use <span class="mc-variable PolicyPak.Product_Short_Name variable">Endpoint Policy Manager</span> Script Manager to run a PowerShell script to enable the service dependencies (if Kaseya also exists).</p>
                                    <p>Upon rebooting the machine all of the Kaseya actions should match the created policies and child processes are allowed as intended.</p>
                                    <p>PS:&#160;Kaseya Agent service' display name should be same as in the script. Please confirm and edit if it's different in your environment.</p>
                                    <p>Steps:</p>
                                    <p class="Step-Reset" data-mc-autonum="&lt;b&gt;Step 1 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 1 – </b></span></span>Create a <span class="mc-variable PolicyPak.Product_Short_Name variable">Endpoint Policy Manager</span> Scripts Manager policy under Computer container</p>
                                    <p>
                                        <img alt="" height="337" src="../../../Resources/Images/Troubleshooting/LeastPrivilege/873_1_image-20211130233051-1.png" width="814" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 2 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 2 – </b></span></span>Select PowerShell script from the drop-down at On apply action window and paste the PowerShell script from below.</p>
                                    <p>
                                        <img alt="" height="843" src="../../../Resources/Images/Troubleshooting/LeastPrivilege/873_2_image-20211130233051-2.png" width="814" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 3 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 3 – </b></span></span>Select ‘Once or when forced' at Specify process mode window.</p>
                                    <p>
                                        <img alt="" height="558" src="../../../Resources/Images/Troubleshooting/LeastPrivilege/873_3_image-20211130233051-3.png" width="854" />
                                    </p>
                                    <p class="Step" data-mc-autonum="&lt;b&gt;Step 4 – &lt;/b&gt;"><span class="autonumber"><span class="Step"><b>Step 4 – </b></span></span>Finish the Wizard to complete the policy creation.</p>
                                    <p>Optional:</p>
                                    <ul>
                                        <li>
                                            <p>Revert script when policy no longer applies or you do not need <span class="mc-variable PolicyPak.Product_Short_Name variable">Endpoint Policy Manager</span> services dependencies for Kaseya Agent Service.</p>
                                            <p>
                                                <img alt="" height="406" src="../../../Resources/Images/Troubleshooting/LeastPrivilege/873_4_image-20211130233051-4.png" width="816" />
                                            </p>
                                        </li>
                                    </ul>
                                    <p>***** Powershell 'apply' script: </p>
                                    <div class="codeSnippet">
                                        <div style="mc-code-lang: PowerShell;" class="codeSnippetBody" data-mc-continue="False" data-mc-line-number-start="1" data-mc-use-line-numbers="False"><pre><code><span style="font-weight: bold; ">$svcKaseya</span> = (<span style="color: #a71d5d; font-weight: bold; ">Get-Service</span> -DisplayName <span style="color: #df5000; ">"Kaseya Agent"</span> | Select -Property Name).Name<br /><span style="font-weight: bold; ">$svcPPHelper</span> = <span style="color: #df5000; ">"PPExtensionSvc*"</span><br /><span style="font-weight: bold; ">$svcPPWatcher</span> = <span style="color: #df5000; ">"PPWatcherSvc*"</span><br /><span style="color: #a71d5d; font-weight: bold; ">if</span> (<span style="font-weight: bold; ">$svc</span> = @(<span style="color: #a71d5d; font-weight: bold; ">get-service</span> <span style="font-weight: bold; ">$svcKaseya</span> -ea <span style="color: #333333; ">0</span>)) {<br /><span style="color: #969896; "># if Kaseya Service has no dependents currently</span><br /><span style="color: #a71d5d; font-weight: bold; ">if</span> (-not <span style="font-weight: bold; ">$svc</span>.ServicesDependedOn) {<br /><span style="color: #969896; "># Build the list of PolicyPak service names</span><br /><span style="font-weight: bold; ">$svcListPP</span> = @()<br /><span style="color: #a71d5d; font-weight: bold; ">if</span> (<span style="font-weight: bold; ">$svc</span> = @(<span style="color: #a71d5d; font-weight: bold; ">get-service</span> <span style="font-weight: bold; ">$svcPPHelper</span> -ea <span style="color: #333333; ">0</span>)) {<br /><span style="color: #a71d5d; font-weight: bold; ">foreach</span> (<span style="font-weight: bold; ">$s</span> <span style="color: #a71d5d; font-weight: bold; ">in</span> <span style="font-weight: bold; ">$svc</span>.Name) {<br /><span style="font-weight: bold; ">$svcListPP</span> += <span style="font-weight: bold; ">$s</span><br />}<br />}<br /><span style="color: #a71d5d; font-weight: bold; ">if</span> (<span style="font-weight: bold; ">$svc</span> = @(<span style="color: #a71d5d; font-weight: bold; ">get-service</span> <span style="font-weight: bold; ">$svcPPWatcher</span> -ea <span style="color: #333333; ">0</span>)) {<br /><span style="color: #a71d5d; font-weight: bold; ">foreach</span> (<span style="font-weight: bold; ">$s</span> <span style="color: #a71d5d; font-weight: bold; ">in</span> <span style="font-weight: bold; ">$svc</span>.Name) {<br /><span style="font-weight: bold; ">$svcListPP</span> += <span style="font-weight: bold; ">$s</span><br />}<br />}<br /><span style="font-weight: bold; ">$svcListPP</span> = <span style="font-weight: bold; ">$svcListPP</span> -join <span style="color: #df5000; ">"/"</span><br /><br /><span style="color: #969896; "># Set the Kaseya service to depend on the PolicyPak services</span><br />&amp; cmd /c sc config <span style="font-weight: bold; ">$svcKaseya</span> depend= <span style="font-weight: bold; ">$svcListPP</span><br /><span style="color: #969896; "># Restart the kaseya agent service</span><br /><span style="color: #a71d5d; font-weight: bold; ">Restart-Service</span> <span style="font-weight: bold; ">$svcKaseya</span><br /><br />}<br />}</code></pre>
                                        </div>
                                    </div>
                                    <p>******Powershell ‘revert' script:</p>
                                    <div class="codeSnippet">
                                        <div style="mc-code-lang: PowerShell;" class="codeSnippetBody" data-mc-continue="False" data-mc-line-number-start="1" data-mc-use-line-numbers="False"><pre><code><span style="font-weight: bold; ">$svcKaseya</span> = (<span style="color: #a71d5d; font-weight: bold; ">Get-Service</span> -DisplayName <span style="color: #df5000; ">"Kaseya Agent"</span> | Select -Property Name).Name<br />&amp; cmd /c sc config <span style="font-weight: bold; ">$svcKaseya</span> depend= /</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><a data-close="true"></a>
                </div>
            </div>
        </div>
    </body>
</html>